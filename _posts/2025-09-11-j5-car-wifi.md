---
layout: post
title:  "j5智能车WIFI控制入门"
author: "David"
header-style: text
tags: 
    - stem教育
    - Maker
    - 智能车
---




好的，为 ESP8266 刷入 StandardFirmataWiFi 是使用 Johnny-Five 通过 WiFi 来控制它的**关键第一步**。

以下是详细的步骤指南。

### 准备工作

1.  **安装 Arduino IDE**
    *   从 [Arduino 官网](https://www.arduino.cc/en/software) 下载并安装最新版的 Arduino IDE。

2.  **安装 ESP8266 开发板支持**
    *   打开 Arduino IDE，进入 `文件 (File) -> 首选项 (Preferences)`。
    *   在“附加开发板管理器网址” (Additional Boards Manager URLs) 中，输入以下网址：
        ```
        http://arduino.esp8266.com/stable/package_esp8266com_index.json
        ```
        （如果已有其他网址，用逗号隔开即可）
    *   点击“好”保存。
    *   然后进入 `工具 (Tools) -> 开发板 (Board) -> 开发板管理器 (Boards Manager...)`。
    *   搜索并输入 "**esp8266**"。
    *   找到并安装由 **ESP8266 Community** 提供的版本（通常是最新的一个）。安装过程可能需要一些时间。

3.  **安装 Firmata 库**
    *   进入 `草图 (Sketch) -> 包含库 (Include Library) -> 管理库 (Manage Libraries...)`。
    *   搜索 "**Firmata**"。
    *   找到并安装 "**Firmata by Firmata Developers**"。

### 刷写固件步骤

完成准备工作后，就可以开始刷写了。

1.  **选择正确的开发板和端口**
    *   用 USB 数据线将 ESP8266（如 NodeMCU、Wemos D1 mini）连接到电脑。
    *   在 Arduino IDE 中，进入 `工具 (Tools) -> 开发板 (Board)`，选择你使用的 ESP8266 型号（例如 `NodeMCU 1.0 (ESP-12E Module)` 或 `LOLIN(WEMOS) D1 R2 & mini`）。
    *   进入 `工具 (Tools) -> 端口 (Port)`，选择对应的串行端口（在 Windows 上是 `COMx`，在 macOS 上是 `/dev/cu.usbserial-xxxx`）。

2.  **打开 StandardFirmataWiFi 示例代码**
    *   进入 `文件 (File) -> 示例 (Examples) -> Firmata -> StandardFirmataWiFi`。

3.  **配置 WiFi 设置（最关键的一步）**
    *   打开的示例代码中，你需要修改开头的网络配置部分。找到以下代码段：

    ```cpp
    // 取消注释以下之一，并修改你的网络配置
    // #define SECRET_SSID "your-network-name"
    // #define SECRET_PASS "your-network-password"

    // 或者手动配置（取消注释并修改下面两行）
    char ssid[] = "your-network-name";       // 你的 WiFi 名称
    char pass[] = "your-network-password";   // 你的 WiFi 密码
    ```

    *   **推荐方法**：直接修改 `char ssid[]` 和 `char pass[]` 这两行，将 `your-network-name` 和 `your-network-password` 替换成你实际的 WiFi 名称和密码。
    *   **确保你的 WiFi 是 2.4GHz 频段**，大多数 ESP8266 模块不支持 5GHz WiFi。

4.  **选择 WiFi 模式（可选但重要）**
    *   在代码中继续往下看，你会找到关于 `FirmataWiFi` 模式的配置：

    ```cpp
    // 取消注释以下之一
    // FirmataWiFi.setWiFiMode(WIFI_AP); // 将ESP8266设置为接入点模式
    FirmataWiFi.setWiFiMode(WIFI_STA); // 将ESP8266设置为站点模式（连接到路由器）
    ```

    *   对于大多数应用，我们希望 ESP8266 连接到现有的路由器。因此，**确保 `WIFI_STA` 模式被取消注释，而 `WIFI_AP` 模式被注释掉**。
    *   **STA (Station) 模式**：ESP8266 像手机、电脑一样连接到你的路由器。这是最常见的方式，方便与在同一局域网内的电脑（运行 Johnny-Five）通信。
    *   **AP (Access Point) 模式**：ESP8266 自己创建一个 WiFi 网络，你的电脑需要连接到这个ESP创建的网络。通常不推荐，除非没有现成路由器。

5.  **上传固件**
    *   点击 Arduino IDE 左上角的“上传”按钮（向右的箭头）。
    *   等待编译和上传完成。底部状态栏会显示“上传完成” (Done uploading)。

### 验证是否成功

上传完成后，ESP8266 会自动重启。要验证它是否成功连接到了 WiFi：

1.  **打开串口监视器** (`工具 -> 串口监视器` 或 `Ctrl+Shift+M`)。
2.  **设置波特率为 115200**。
3.  观察串口输出。如果配置正确，你会看到类似以下的信息，其中包含了ESP8266从路由器获取到的**IP地址**。**这个IP地址非常重要，在 Johnny-Five 代码中会用到它。**

    ```
    [Firmata] Connecting to Wi-Fi...
    [Firmata] Wi-Fi connection established.
    [Firmata] Local IP: 192.168.1.123 // <- 这就是你需要的IP地址！
    [Firmata] Waiting for connection...
    ```

### 在 Johnny-Five 代码中使用

刷写成功后，你的 Johnny-Five 代码就可以通过 `EtherPortClient` 连接到这个 IP 地址来控制 ESP8266 了。

```javascript
const { Board } = require('johnny-five');
const { EtherPortClient } = require('etherport-client');

const board = new Board({
  port: new EtherPortClient({
    host: '192.168.1.123', // 替换为你从串口监视器看到的IP
    port: 3030 // 默认端口，通常不需要改
  }),
  timeout: 10000 // 建议设置连接超时
});

board.on('ready', function() {
  console.log('ESP8266连接成功！');
  // 在这里初始化你的传感器和执行器，例如：
  const led = new five.Led(2); // 控制NodeMCU上的内置LED（GPIO2）
  led.blink(500);
});
```

参考nodemcu引脚：![nodemcu引脚图](http://www.taichi-maker.com/wp-content/uploads/2019/02/esp8266_devkit_horizontal-001.png)


参考nodemcu底板供电：![nodemcu底板供电](https://ts4.tc.mm.bing.net/th/id/OIP-C.-1Mk1YOQFJlWi9eUQYrD1wHaHK?rs=1&pid=ImgDetMain&o=7&rm=3)
我们可以任意控制各引脚作为开关量，或者pwm输出从而控制灯的闪烁，小车的运动


### 常见问题及解决方法

*   **上传失败**：
    *   检查是否选对了**开发板型号**和**串行端口**。
    *   尝试按一下 ESP8266 开发板上的 `RST` (复位) 按钮，然后重新上传。
    *   确保 USB 数据线可以传输数据（有些线只能充电）。

*   **串口监视器看不到 IP 地址，提示连接失败**：
    *   **99% 的原因都是 WiFi 密码错误或 WiFi 名称（SSID）有特殊字符（如空格、中文）**。请仔细检查并修改代码中的 `ssid` 和 `pass`。
    *   确保 WiFi 是 2.4GHz 网络。
    *   检查路由器是否设置了 MAC 地址过滤，如果是，请将 ESP8266 的 MAC 地址加入白名单。

*   **Johnny-Five 连接超时**：
    *   确认 Johnny-Five 代码中的 `host` IP 地址与串口监视器中看到的完全一致。
    *   确保运行 Johnny-Five 的电脑和 ESP8266 在**同一个局域网**（连接的是同一个路由器）。
    *   检查电脑或路由器防火墙是否屏蔽了 `3030` 端口。

按照以上步骤，你就能成功为 ESP8266 刷入 FirmataWiFi 固件，为后续的 Web 前端控制打下坚实的基础。